name: CI/CD

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Restore .NET dependencies
      run: dotnet restore

    - name: Build .NET
      run: dotnet build --configuration Release --no-restore

    - name: Test .NET
      run: dotnet test --no-restore --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage

    - name: Generate .NET Coverage Report
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator -reports:./coverage/**/*.xml -targetdir:./coverage-report -reporttypes:Html
      if: success()

    - name: Upload .NET Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-coverage-report
        path: ./coverage-report/
      if: success()

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: NourishlyApp/package-lock.json

    - name: Install Angular dependencies
      run: npm ci
      working-directory: NourishlyApp

    - name: Test Angular
      run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage
      working-directory: NourishlyApp

    - name: Build Angular
      run: npm run build -- --configuration production
      working-directory: NourishlyApp

    - name: Upload Angular Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: angular-coverage-report
        path: NourishlyApp/coverage/
      if: success()

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Publish DiningAPI
      run: dotnet publish DiningAPI/DiningAPI.csproj --configuration Release --output ./publish/DiningAPI

    - name: Publish NotificationsAPI
      run: dotnet publish NotificationsAPI/NotificationsAPI.csproj --configuration Release --output ./publish/NotificationsAPI

    - name: Publish UserAPI
      run: dotnet publish UserAPI/UserAPI.csproj --configuration Release --output ./publish/UserAPI

    - name: Upload .NET Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: published-apps
        path: ./publish/

    - name: Download Coverage Reports
      uses: actions/download-artifact@v4
      with:
        name: dotnet-coverage-report
        path: ./dotnet-coverage

    - name: Download Angular Coverage Reports
      uses: actions/download-artifact@v4
      with:
        name: angular-coverage-report
        path: ./angular-coverage

    - name: Prepare the webpage
      run: |
        mkdir sites
        mv NourishlyApp/dist/nourishly-app/browser/* sites/
        mv ./dotnet-coverage sites/dotnet-coverage
        mv ./angular-coverage sites/angular-coverage

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./sites
